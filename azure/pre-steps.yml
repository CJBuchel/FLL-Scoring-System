steps:
  # Init
  - script: git submodule update --init --recursive
  - script: git submodule update --remote --recursive -f

  # Install java
  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '17'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'

  # Rust install
  - task: Rustup@1
    inputs:
      rustupCommand: 'target install x86_64-unknown-linux-musl'
      verbose: false

  - task: Cargo@1
    inputs:
      cargoCommand: 'build'
      cargoWorkingDir: './server'
      verbose: false

  # Setup environment variables
  - task: CmdLine@2
    inputs:
      script: while IFS= read -r line; do export $line; done < ./.env

  - task: Npm@1
    inputs:
      command: 'install'
      workingDir: './tms'

  - task: Npm@1
    inputs:
      command: 'custom'
      workingDir: './tms'
      customCommand: 'run prepare'

  # Install flutter
  - task: FlutterInstall@0
    inputs:
      mode: 'auto'
      channel: 'stable'
      version: 'custom'
      customVersion: '3.7.8'

  - task: FlutterCommand@0
    inputs:
      projectDirectory: './tms'
      arguments: 'doctor -v'