parameters:
- name: target
  type: string

steps:
  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: '$(p12_alias)'
      # certPwd: '$(cert_pass)'
      keychain: 'temp'
      deleteCert: true

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: '$(pp_alias)'
      removeProfile: true

  - task: Xcode@5
    displayName: "Code sign ipa for Distribution"
    inputs:
      actions: "build"
      xcWorkspacePath: "**/Runner.xcworkspace"
      scheme: "Runner"
      sdk: "iphoneos"
      configuration: "release"
      packageApp: true
      signingOption: "manual"
      signingIdentity: '$(APPLE_CERTIFICATE_SIGNING_IDENTITY)'
      provisioningProfileUuid: '$(APPLE_PROV_PROFILE_UUID)'

  # Build the flutter app
  - task: FlutterBuild@0
    inputs:
      target: '${{parameters.target}}'
      projectDirectory: './tms'
      debugMode: false
      profileMode: false
      extraArgs: '--release'

  # - task: CopyFiles@2
  #   inputs:
  #     contents: '**/flutter-apk/**/*.apk'
  #     targetFolder: $(Build.ArtifactStagingDirectory)

  - task: CopyFiles@2
    inputs:
      contents: '**/*.ipa'
      targetFolder: $(Build.ArtifactStagingDirectory)

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: $(Build.ArtifactStagingDirectory)
      artifactName: 'client-${{parameters.target}}'
