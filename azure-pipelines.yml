trigger:
- master
- docker-publish

resources:
- repo: self

variables:
  isPublishable: $[or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.SourceBranch'], 'refs/heads/docker-publish'))]
  tag: '$(Build.BuildId)'

jobs:
- job: BuildPublish
  displayName: Build & Publish CJ-MS
  pool:
    vmImage: ubuntu-latest
  steps:

  - script: chmod +x ./docker-create-env.sh
  # - script: ./docker-create-env.sh

  - task: Bash@3
    inputs:
      filePath: '$(System.DefaultWorkingDirectory)/docker-create-env.sh'
      workingDirectory: '$(System.DefaultWorkingDirectory)'
      failOnStderr: true

  # Build Node App
  - task: NodeTool@0
    inputs:
      versionSpec: '>=10.x'
    displayName: 'Install Node.js'
  - script: npm install -g yarn
  - script: yarn install
  - script: yarn run build

  # Build Docker app
  - task: CmdLine@2
    inputs:
      script: docker-compose build --pull

  # Publish Docker app
  - task: CmdLine@2
    condition: and(succeeded(), eq(variables.isPublishable, 'true'))
    inputs:
      script: docker login -u cjbuchel -p $(cjms-token); docker-compose push; docker logout