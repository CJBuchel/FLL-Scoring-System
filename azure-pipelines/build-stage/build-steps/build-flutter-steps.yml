parameters:
- name: target

steps:
  # replace msix_version: 0.0.0.0 with msix_version: $(version).$(Build.BuildNumber) in pubspec.yaml
  # file: ./client/pubspec.yaml

  - powershell: |
      $buildNumber = "$(Build.BuildNumber)".Replace('.', '') # Merges the numbers by removing the dot
      $newMsixVersion = "$(version).$buildNumber"
      (Get-Content -Path 'client\pubspec.yaml') -replace 'msix_version: (\d+\.)\d+\.\d+\.\d+', "msix_version: $newMsixVersion" | Set-Content -Path 'client\pubspec.yaml'
      Get-Content -Path 'client\pubspec.yaml' | ForEach-Object { Write-Host $_ }
    displayName: 'Update MSIX Version in pubspec.yaml and print it'
    condition: eq(variables['Agent.OS'], 'Windows_NT')

  # install the msix package for windows
  - task: FlutterCommand@0
    displayName: 'Install MSIX Package'
    condition: eq( variables['Agent.OS'], 'Windows_NT' )
    inputs:
      projectDirectory: './client'
      arguments: 'pub add --dev msix'

  # Build flutter app
  - task: FlutterBuild@0
    displayName: "Build Flutter App: ${{parameters.target}}"
    inputs:
      target: '${{parameters.target}}'
      projectDirectory: './client'
      debugMode: false
      profileMode: false
      iosCodesign: false
      extraArgs: '--release'

      # build
      buildName: $(version) # replace with actual version
      buildNumber: $(Build.BuildNumber) # auto increment

  # create the msix package for windows
  - task: FlutterCommand@0
    displayName: 'Create MSIX Package'
    condition: eq( variables['Agent.OS'], 'Windows_NT' )
    inputs:
      projectDirectory: './client'
      arguments: 'pub run msix:create --build-windows false'